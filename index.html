<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profilbild-Manager</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.21.2/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .circular-image {
            width: 128px;
            height: 128px;
            border-radius: 50%;
            object-fit: cover;
            object-position: center;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useRef, useCallback } = React;

        // Vereinfachte Icon-Komponenten
        const Upload = () => <span>üì§</span>;
        const Crop = () => <span>‚úÇÔ∏è</span>;
        const Trash2 = () => <span>üóëÔ∏è</span>;

        // Shadcn UI-√§hnliche Komponenten
        const Button = ({ children, onClick, className, variant }) => (
            <button 
                onClick={onClick} 
                className={`px-4 py-2 rounded-md ${
                    variant === 'destructive' ? 'bg-red-500 text-white' : 
                    variant === 'outline' ? 'border border-gray-300' : 
                    'bg-blue-500 text-white'
                } ${className}`}
            >
                {children}
            </button>
        );

        const Input = React.forwardRef((props, ref) => (
            <input ref={ref} {...props} className="border rounded-md px-2 py-1" />
        ));

        const Alert = ({ children, variant }) => (
            <div className={`p-4 rounded-md ${variant === 'destructive' ? 'bg-red-100 text-red-800' : 'bg-blue-100 text-blue-800'}`}>
                {children}
            </div>
        );

        const Dialog = ({ open, onOpenChange, children }) => {
            if (!open) return null;
            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
                    <div className="bg-white p-6 rounded-lg">
                        {children}
                        <button onClick={() => onOpenChange(false)} className="mt-4 px-4 py-2 bg-gray-200 rounded-md">Schlie√üen</button>
                    </div>
                </div>
            );
        };

        const ProfileImageManager = () => {
            const [image, setImage] = useState(null);
            const [previewUrl, setPreviewUrl] = useState(null);
            const [error, setError] = useState(null);
            const [isCropDialogOpen, setIsCropDialogOpen] = useState(false);
            const fileInputRef = useRef(null);

            const MAX_FILE_SIZE = 5 * 1024 * 1024; // 5 MB
            const SUPPORTED_FORMATS = ['image/jpeg', 'image/png'];
            const MAX_IMAGE_SIZE = 300; // Maximale Breite oder H√∂he f√ºr die Vorschau

            const scaleImage = useCallback((file) => {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            let width = img.width;
                            let height = img.height;

                            if (width > height) {
                                if (width > MAX_IMAGE_SIZE) {
                                    height *= MAX_IMAGE_SIZE / width;
                                    width = MAX_IMAGE_SIZE;
                                }
                            } else {
                                if (height > MAX_IMAGE_SIZE) {
                                    width *= MAX_IMAGE_SIZE / height;
                                    height = MAX_IMAGE_SIZE;
                                }
                            }

                            canvas.width = width;
                            canvas.height = height;
                            ctx.drawImage(img, 0, 0, width, height);
                            canvas.toBlob(resolve, file.type);
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                });
            }, []);

            const handleImageUpload = useCallback(async (event) => {
                const file = event.target.files[0];
                if (file) {
                    if (file.size > MAX_FILE_SIZE) {
                        setError('Die Datei ist zu gro√ü. Maximale Gr√∂√üe ist 5 MB.');
                        return;
                    }
                    if (!SUPPORTED_FORMATS.includes(file.type)) {
                        setError('Nicht unterst√ºtztes Bildformat. Bitte JPEG oder PNG verwenden.');
                        return;
                    }
                    setError(null);

                    try {
                        const scaledBlob = await scaleImage(file);
                        setImage(scaledBlob);
                        setPreviewUrl(URL.createObjectURL(scaledBlob));
                    } catch (err) {
                        setError('Fehler beim Verarbeiten des Bildes. Bitte versuchen Sie es erneut.');
                    }
                }
            }, [scaleImage]);

            const handleDeleteImage = useCallback(() => {
                setImage(null);
                setPreviewUrl(null);
                if (fileInputRef.current) {
                    fileInputRef.current.value = '';
                }
            }, []);

            const handleCropImage = useCallback(() => {
                setIsCropDialogOpen(true);
            }, []);

            const handleSaveImage = useCallback(() => {
                console.log('Bild gespeichert:', image);
            }, [image]);

            return (
                <div className="max-w-md mx-auto p-4">
                    <h2 className="text-2xl font-bold mb-4">Profilbild verwalten</h2>
                    
                    {previewUrl && (
                        <div className="mb-4 flex justify-center">
                            <img src={previewUrl} alt="Profilbild Vorschau" className="circular-image" />
                        </div>
                    )}
                    
                    <div className="flex gap-2 mb-4">
                        <Button onClick={() => fileInputRef.current.click()}>
                            <Upload /> Bild hochladen
                        </Button>
                        <Input
                            type="file"
                            ref={fileInputRef}
                            className="hidden"
                            onChange={handleImageUpload}
                            accept="image/jpeg,image/png"
                        />
                        
                        {image && (
                            <>
                                <Button variant="outline" onClick={handleCropImage}>
                                    <Crop /> Zuschneiden
                                </Button>
                                <Button variant="destructive" onClick={handleDeleteImage}>
                                    <Trash2 /> L√∂schen
                                </Button>
                            </>
                        )}
                    </div>
                    
                    {error && (
                        <Alert variant="destructive" className="mb-4">
                            {error}
                        </Alert>
                    )}
                    
                    {image && (
                        <Button onClick={handleSaveImage} className="w-full">
                            Profilbild speichern
                        </Button>
                    )}

                    <Dialog open={isCropDialogOpen} onOpenChange={setIsCropDialogOpen}>
                        <h3 className="text-lg font-semibold mb-4">Bild zuschneiden</h3>
                        <div className="flex items-center justify-center h-64 bg-gray-100">
                            {previewUrl && <img src={previewUrl} alt="Zuschneiden" className="circular-image" />}
                        </div>
                    </Dialog>
                </div>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<ProfileImageManager />);
    </script>
</body>
</html>
